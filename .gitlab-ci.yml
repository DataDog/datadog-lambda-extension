variables:
  DOCKER_TARGET_IMAGE: registry.ddbuild.io/ci/datadog-lambda-extension
  DOCKER_TARGET_VERSION: latest
  # Manual trigger variables
  AGENT_BRANCH:
    description: "Branch of the datadog-agent repository to use."
    value: main
  LAYER_SUFFIX:
    description: "Suffix to be appended to the layer name (default empty)."
    value: ""

stages:
  - generate
  - build

ci image:
  stage: build
  image: registry.ddbuild.io/images/docker:20.10
  tags: ["arch:arm64"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
      changes:
        - .gitlab/Dockerfile
      when: on_success
  variables:
    DOCKER_TARGET: ${DOCKER_TARGET_IMAGE}:${DOCKER_TARGET_VERSION}
  script:
    - docker buildx build --platform linux/amd64,linux/arm64 --no-cache --pull --push --tag ${DOCKER_TARGET} -f .gitlab/Dockerfile .

.go-cache: &go-cache
  key: datadog-lambda-extension-go-cache
  policy: pull

generator:
  stage: generate
  image: registry.ddbuild.io/images/mirror/golang:alpine
  tags: ["arch:amd64"]
  cache: *go-cache
  script:
    - apk add --no-cache gomplate
    - gomplate --config .gitlab/config.yaml
  artifacts:
    paths:
      - .gitlab/pipeline-bottlecap.yaml
      - .gitlab/pipeline-go-agent.yaml
      - .gitlab/pipeline-lambda-extension.yaml

bottlecap-only:
  stage: build
  trigger:
    include:
      - artifact: .gitlab/pipeline-bottlecap.yaml
        job: generator
    strategy: depend
  rules:
    - when: on_success

go-agent-only:
  stage: build
  trigger:
    include:
      - artifact: .gitlab/pipeline-go-agent.yaml
        job: generator
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
  variables:
    AGENT_BRANCH: $AGENT_BRANCH
    LAYER_SUFFIX: $LAYER_SUFFIX

lambda-extension:
  stage: build
  trigger:
    include:
      - artifact: .gitlab/pipeline-lambda-extension.yaml
        job: generator
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
  variables:
    AGENT_BRANCH: $AGENT_BRANCH
    LAYER_SUFFIX: $LAYER_SUFFIX
