name: "Vulnerability Scan"

on:
  pull_request:
  schedule:
    # daily at midnight
    - cron: "0 0 * * *"
  workflow_dispatch:

env:
  # adds public.ecr.aws as fallback incase rate limit on ghcr.io is hit
  TRIVY_DB_REPOSITORY: ghcr.io/aquasecurity/trivy-db,public.ecr.aws/aquasecurity/trivy-db
  TRIVY_JAVA_DB_REPOSITORY: ghcr.io/aquasecurity/trivy-java-db,public.ecr.aws/aquasecurity/trivy-java-db

jobs:
  trivy-scans:
    runs-on: ubuntu-22.04
    steps:
      - name: Scan latest released image with trivy
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          image-ref: "public.ecr.aws/datadog/lambda-extension:latest"
          ignore-unfixed: true
          exit-code: 1
          format: table

      - name: Scan latest-alpine released image with trivy
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          image-ref: "public.ecr.aws/datadog/lambda-extension:latest-alpine"
          ignore-unfixed: true
          exit-code: 1
          format: table

  grype-scans:
    runs-on: ubuntu-22.04
    steps:
      - name: Scan latest release image with grype
        uses: anchore/scan-action@40a61b52209e9d50e87917c5b901783d546b12d0 # v7.2.1
        with:
          image: "public.ecr.aws/datadog/lambda-extension:latest"
          only-fixed: true
          fail-build: true
          severity-cutoff: low
          output-format: table

      - name: Scan latest-alpine release image with grype
        uses: anchore/scan-action@40a61b52209e9d50e87917c5b901783d546b12d0 # v7.2.1
        with:
          image: "public.ecr.aws/datadog/lambda-extension:latest-alpine"
          only-fixed: true
          fail-build: true
          severity-cutoff: low
          output-format: table

  rust-dependency-scan:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Scan Rust dependencies with cargo-audit
        uses: rustsec/audit-check@69366f33c96575abad1ee0dba8212993eecbe998 # v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          working-directory: bottlecap

  build-and-scan-images:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - arch: amd64
            alpine: 0
            suffix: amd64
          - arch: amd64
            alpine: 1
            suffix: amd64-alpine
          - arch: arm64
            alpine: 0
            suffix: arm64
          - arch: arm64
            alpine: 1
            suffix: arm64-alpine
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0
        with:
          image: tonistiigi/binfmt:qemu-v9.2.2-52 #v3.6.0 latest
          platforms: amd64,arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@d70bba72b1f3fd22344832f00baa16ece964efeb # v3.3.0

      - name: Compile binary (${{ matrix.suffix }})
        run: |
          ARCHITECTURE=${{ matrix.arch }} ALPINE=${{ matrix.alpine }} FIPS=0 DEBUG=0 FILE_SUFFIX=${{ matrix.suffix }} ./.gitlab/scripts/compile_bottlecap.sh
        env:
          DOCKER_BUILDKIT: 1

      - name: Build layer (${{ matrix.suffix }})
        run: |
          ARCHITECTURE=${{ matrix.arch }} FILE_SUFFIX=${{ matrix.suffix }} ./.gitlab/scripts/build_layer.sh
        env:
          DOCKER_BUILDKIT: 1

      - name: Scan layer image with trivy
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          image-ref: "datadog/build-extension-${{ matrix.suffix }}"
          ignore-unfixed: true
          exit-code: 1
          format: table

      - name: Scan layer image with grype
        uses: anchore/scan-action@40a61b52209e9d50e87917c5b901783d546b12d0 # v7.2.1
        with:
          image: "datadog/build-extension-${{ matrix.suffix }}"
          only-fixed: true
          fail-build: true
          severity-cutoff: low
          output-format: table

      - name: Scan binary file with grype
        uses: anchore/scan-action@40a61b52209e9d50e87917c5b901783d546b12d0 # v7.2.1
        with:
          path: .binaries/bottlecap-${{ matrix.suffix }}
          only-fixed: true
          fail-build: true
          severity-cutoff: low
          output-format: table

      - name: Scan layer files with grype
        uses: anchore/scan-action@40a61b52209e9d50e87917c5b901783d546b12d0 # v7.2.1
        with:
          path: .layers/datadog_extension-${{ matrix.suffix }}
          only-fixed: true
          fail-build: true
          severity-cutoff: low
          output-format: table

      # Scan the compile image only once (it's the same for all variants)
      # Only run for the first matrix job to avoid redundant scans
      - name: Scan compile image with trivy
        if: matrix.suffix == 'amd64'
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          image-ref: "datadog/compile-bottlecap"
          ignore-unfixed: true
          exit-code: 1
          format: table

      - name: Scan compile image with grype
        if: matrix.suffix == 'amd64'
        uses: anchore/scan-action@3aaf50d765cfcceafa51d322ccb790e40f6cd8c5 # v7.2.0
        with:
          image: "datadog/compile-bottlecap"
          only-fixed: true
          fail-build: true
          severity-cutoff: low
          output-format: table

  retry:
    needs: [trivy-scans, grype-scans, rust-dependency-scan, build-and-scan-images]
    if: failure() && fromJSON(github.run_attempt) < 2
    runs-on: ubuntu-22.04
    permissions:
      actions: write
    steps:
      - name: Retry failed action
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
        run: gh workflow run retry-workflow.yml -F run_id=${{ github.run_id }}

  notify:
    needs: [trivy-scans, grype-scans, rust-dependency-scan, build-and-scan-images]
    if: failure() && fromJSON(github.run_attempt) >= 2
    runs-on: ubuntu-22.04
    steps:
      - name: Notify
        env:
          SLACK_CHANNEL: "#serverless-agent"
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          set -x

          OPS_MESSAGE=":gh-check-failed: Lambda Extension Vulnerability Scan failed! :radar-scan:

          Whoever is on support, please fix the vulnerability, before a customer alerts us to it.

          See ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID} for the full info on the found vulnerability. :bufo-thanks:"

          curl -H "Content-type: application/json" -X POST "$SLACK_WEBHOOK" -d '{
            "channel": "'"$SLACK_CHANNEL"'",
            "text": "'"$OPS_MESSAGE"'"
          }'
